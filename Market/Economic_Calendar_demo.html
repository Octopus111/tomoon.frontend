<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400, initial-scale=0.25, maximum-scale=3, user-scalable=yes">
    <title>Economic Calendar - ToMoon</title>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-card: #1a1d24;
            --bg-panel: #232730;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --sidebar-width: 60px; /* Default collapsed */
            
            /* Calendar Specific */
            --impact-high: #ef4444;
            --impact-medium: #f59e0b;
            --impact-low: #0ea5e9; /* Light blue */
            --impact-holiday: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Calendar theme overrides */
        .calendar-theme {
            --bg-dark: #090a0d;
            --bg-card: #14161b;
            --bg-panel: #1c1f26;
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.3);
            --text-main: #f1f5f9;
            --text-muted: #64748b;
            --border: #2d333f;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
        }

        /* --- Main Layout --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-container {
            padding: 8px 16px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        /* --- New Header Style --- */
        .calendar-theme .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
        }

        .calendar-theme .title-section h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .calendar-theme .title-section p {
            margin: 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* --- Modern Controls Area --- */
        .calendar-theme .controls-toolbar {
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .calendar-theme .toolbar-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-theme .nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .calendar-theme .nav-group {
            display: flex;
            align-items: center;
            background: var(--bg-panel);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .calendar-theme .date-display {
            font-weight: 600;
            padding: 0 16px;
            font-size: 14px;
            min-width: 180px;
            text-align: center;
        }

        /* --- Refined Card --- */
        .calendar-theme .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .calendar-theme .btn {
            height: 36px;
            padding: 0 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text-main);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .calendar-theme .btn:hover {
            background: #2d333f;
            border-color: var(--text-muted);
        }

        .calendar-theme .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .calendar-theme .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .calendar-theme .btn-icon {
            padding: 0;
            width: 36px;
            justify-content: center;
        }

        /* --- Calendar Header Controls --- */
        .cal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-range-display {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .timezone-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 200px;
        }

        /* Custom Today dropdown calendar */
        .date-dropdown {
            position: absolute;
            top: calc(var(--topbar-height, 60px) + 8px);
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 120;
            padding: 12px;
            width: 260px;
            display: none;
        }
        .date-dropdown.show { display: block; }
        .date-dropdown .cal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .date-dropdown .cal-title { font-weight:600; font-size:14px; }
        .date-dropdown .cal-nav button { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:4px 8px; border-radius:6px; cursor:pointer; }
        .date-dropdown .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
        .date-dropdown .cal-weekday { font-size:11px; color:var(--text-muted); text-align:center; }
        .date-dropdown .cal-day { height:34px; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:6px; color:var(--text-main); }
        .date-dropdown .cal-day.empty { pointer-events:none; color:transparent; }
        .date-dropdown .cal-day:hover { background: rgba(255,255,255,0.03); }
        .date-dropdown .cal-day.selected { background: var(--primary); color: white; }
        .date-dropdown .cal-shortcuts { margin-top:8px; display:flex; gap:8px; justify-content:space-between; }
        .date-dropdown .shortcut { font-size:12px; color:var(--text-muted); cursor:pointer; padding:6px 8px; border-radius:6px; border:1px solid transparent; }
        .date-dropdown .shortcut:hover { background: rgba(255,255,255,0.03); border-color:var(--border); color:var(--text-main); }

        /* --- Day Tabs Re-design --- */
        .calendar-theme .day-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .calendar-theme .day-tab {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-theme .day-tab .day-name {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .calendar-theme .day-tab .day-date {
            font-size: 15px;
            font-weight: 700;
        }

        .calendar-theme .day-tab:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--text-muted);
        }

        .calendar-theme .day-tab.active {
            background: var(--primary-glow);
            border-color: var(--primary);
            position: relative;
        }

        .calendar-theme .day-tab.active::after {
            content: "";
            position: absolute;
            bottom: -1px;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        
        /* Expandable Row Details */
        .event-details-row {
            background-color: var(--bg-card); /* Match card bg but maybe slightly lighter/darker? */
            border-bottom: 1px solid var(--border);
            display: none; 
        }
        
        .event-details-container {
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border-top: 1px dashed var(--border);
            display: flex;
            gap: 20px;
        }

        .event-chart-placeholder {
            flex: 2;
            height: 120px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            border: 1px dashed var(--border);
        }

        .event-meta-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            font-size: 12px;
        }
        
        .meta-row { display: flex; justify-content: space-between; }
        .meta-label { color: var(--text-muted); }
        .meta-val { font-weight: 600; }
        
        .event-row {
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
            cursor: pointer; /* Indicate clickable */
        }
        
        .event-row.expanded {
            background: rgba(255,255,255,0.03);
            border-bottom: none; /* Remove border between row and its details */
        }
        
        /* --- Modern Filter Section --- */
        .calendar-theme .filter-bar {
            padding: 12px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 32px;
            flex-wrap: wrap;
        }

        .calendar-theme .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-theme .filter-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Custom Checkbox Pills */
        .calendar-theme .pill-checkbox {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .calendar-theme .pill-checkbox input { display: none; }

        .calendar-theme .pill-content {
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .calendar-theme .pill-checkbox input:checked + .pill-content.low { background: rgba(59, 130, 246, 0.15); color: var(--impact-low); border-color: var(--impact-low); }
        .calendar-theme .pill-checkbox input:checked + .pill-content.medium { background: rgba(245, 158, 11, 0.15); color: var(--impact-medium); border-color: var(--impact-medium); }
        .calendar-theme .pill-checkbox input:checked + .pill-content.high { background: rgba(239, 68, 68, 0.15); color: var(--impact-high); border-color: var(--impact-high); }
        .calendar-theme .pill-checkbox input:checked + .pill-content.holiday { background: rgba(148, 163, 184, 0.15); color: var(--text-main); border-color: var(--text-muted); }

        .calendar-theme .select-modern {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            outline: none;
        }

        /* --- Table Styling (As requested to keep layout, but refined looks) --- */
        .calendar-theme .event-scroll {
            overflow-y: auto;
            flex: 1;
        }

        .calendar-theme .event-scroll::-webkit-scrollbar {
            display: none;
        }

        .calendar-theme .event-list { width: 100%; border-collapse: collapse; }

        .calendar-theme .event-group-header {
            position: sticky;
            top: 0;
            background: #1a1d24;
            z-index: 10;
        }
        .calendar-theme .group-header-cell {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            background: rgba(59, 130, 246, 0.05);
        }

        .calendar-theme .header-row td {
            background: var(--bg-card);
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .calendar-theme .event-row {
            border-bottom: 1px solid var(--border);
            transition: 0.1s;
        }
        .calendar-theme .event-row:hover { background: rgba(255,255,255,0.02); }

        .calendar-theme .event-cell { padding: 16px 20px; font-size: 13px; }
        .calendar-theme .cell-data { font-family: inherit; font-weight: 600; text-align: right; }

        /* Expired Row Styling */
        .event-row.event-expired {
            opacity: 0.5;
            background: rgba(0,0,0,0.1); 
        }

        /* Signal Bars for Impact */
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 14px;
            width: 18px;
            margin-right: 12px;
        }
        .signal-bar {
            width: 4px;
            background: #334155; /* Inactive color */
            border-radius: 1px;
        }
        .signal-bar:nth-child(1) { height: 6px; }
        .signal-bar:nth-child(2) { height: 10px; }
        .signal-bar:nth-child(3) { height: 14px; }

        /* Active colors */
        .impact-low .signal-bar:nth-child(1) { background: var(--impact-low); }
        
        .impact-medium .signal-bar:nth-child(1),
        .impact-medium .signal-bar:nth-child(2) { background: var(--impact-medium); }
        
        .impact-high .signal-bar:nth-child(1),
        .impact-high .signal-bar:nth-child(2),
        .impact-high .signal-bar:nth-child(3) { background: var(--impact-high); }

        .currency-flag {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .flag-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px; /* Text inside flag */
            overflow: hidden;
            color: #fff;
            position: relative;
        }
        /* Simple flag simulation */
        .flag-us { background: linear-gradient(to bottom, #3c3b6e 50%, #b22234 50%); }
        .flag-eu { background: #003399; }
        .flag-uk { background: #00247d; }
        .flag-ca { background: #ff0000; }
        
        .status-text {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            display: block;
        }
        .status-countdown {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }
        .status-countdown svg { width: 10px; height: 10px; }

        /* Data Colors */
        .data-better { color: var(--success); }
        .data-worse { color: var(--danger); }
        .data-neutral { color: var(--text-main); }
        .data-waiting { color: var(--text-muted); opacity: 0.5; }



        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .day-tabs {
                grid-template-columns: repeat(5, minmax(80px, 1fr));
                overflow-x: auto;
                padding-bottom: 5px;
            }
            .filter-section {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            .event-list, .event-row, .event-cell {
                display: block;
                width: 100%;
            }
            .event-row { padding: 15px; position: relative; }
            .event-cell { padding: 4px 0; text-align: left; width: auto; }
            .cell-data { text-align: left; display: inline-block; margin-right: 15px; }
            .cell-data::before { content: attr(data-label) ": "; color: var(--text-muted); }
            
            .cell-actions { position: absolute; top: 15px; right: 15px; }
            .event-group-header { position: sticky; top: 0; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Topbar placeholder handled by JS -->
        <div id="topbar-placeholder"></div>

        <div class="content-container calendar-theme">
            
            <div class="calendar-header">
                <div class="title-section">
                    <h1>Economic Calendar</h1>
                    <p>Track high-impact financial events in real-time</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select class="select-modern">
                        <option>21:29 Asia/Shanghai (GMT+8)</option>
                        <option>UTC (GMT+0)</option>
                    </select>
                    <button class="btn btn-primary">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export
                    </button>
                </div>
            </div>

            <!-- Today Dropdown -->
            <div id="today-dropdown" class="date-dropdown"></div>

            <div class="card">
                
                <div class="controls-toolbar">
                    <div class="toolbar-top">
                        <button class="btn" id="today-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            Select Day
                        </button>
                        <div class="nav-container">
                            <button class="btn btn-icon" style="border:none; background:transparent;" id="week-prev-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            </button>
                            <span class="date-display" id="week-range-display">26 Jan - 30 Jan 2026</span>
                            <button class="btn btn-icon" style="border:none; background:transparent;" id="week-next-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </button>
                        </div>
                        <div class="spacer"></div>
                    </div>

                    <div class="day-tabs">
                        <div class="day-tab active" id="tab-26">
                            <span class="day-name">Mon</span>
                            <span class="day-date">26</span>
                        </div>
                        <div class="day-tab" id="tab-27">
                            <span class="day-name">Tue</span>
                            <span class="day-date">27</span>
                        </div>
                        <div class="day-tab" id="tab-28">
                            <span class="day-name">Wed</span>
                            <span class="day-date">28</span>
                        </div>
                        <div class="day-tab" id="tab-29">
                            <span class="day-name">Thu</span>
                            <span class="day-date">29</span>
                        </div>
                        <div class="day-tab" id="tab-30">
                            <span class="day-name">Fri</span>
                            <span class="day-date">30</span>
                        </div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Impact</span>
                        <label class="pill-checkbox">
                            <input type="checkbox">
                            <div class="pill-content holiday">Holidays</div>
                        </label>
                        <label class="pill-checkbox">
                            <input type="checkbox" checked>
                            <div class="pill-content low">Low</div>
                        </label>
                        <label class="pill-checkbox">
                            <input type="checkbox" checked>
                            <div class="pill-content medium">Medium</div>
                        </label>
                        <label class="pill-checkbox">
                            <input type="checkbox" checked>
                            <div class="pill-content high">High</div>
                        </label>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">Visibility</span>
                        <label class="pill-checkbox">
                            <input type="checkbox">
                            <div class="pill-content holiday">Hide past news</div>
                        </label>
                        <label class="pill-checkbox">
                            <input type="checkbox">
                            <div class="pill-content holiday">Show only restricted events</div>
                        </label>
                    </div>

                    <div class="filter-group" style="margin-left: auto;">
                        <span class="filter-label">Instrument</span>
                        <select class="select-modern">
                            <option>All Assets</option>
                            <option>USD Only</option>
                        </select>
                    </div>
                </div>

                <!-- Event List Table -->
                <div class="event-scroll">
                    <table class="event-list">
                        <!-- thead removed for sticky group headers layout -->
                        <tbody id="events-body">
                            <!-- Content populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: right; color: var(--text-muted); font-size: 11px; margin-top: 12px; letter-spacing: 0.5px;">
                SOURCE: <a href="#" style="color: var(--text-muted);">FOREXFACTORY.COM</a>
            </div>
            
        </div>
    </main>

    <!-- Scripts -->
    <script src="../shared/sidebar.js"></script>
    <script src="../shared/topbar.js"></script>
    <script>
    // Debug: Check if script parsing starts
    console.log('Calendar: Script block parsing started');

    (function() {
        console.log('Calendar: IIFE executing...');

        // Initialize Sidebar & Topbar safely
        try {
            if (typeof initSidebar === 'function') {
                initSidebar('market', 'calendar', { internalSwitch: false });
                console.log('Calendar: Sidebar initialized');
            } else {
                console.warn('Calendar: initSidebar not found');
            }
            
            if (typeof initTopbar === 'function') {
                initTopbar({ title: 'E-Calendar', basePath: '..' });
                console.log('Calendar: Topbar initialized');
            } else {
                console.warn('Calendar: initTopbar not found');
            }
        } catch (e) {
            console.error('Calendar: Sidebar/Topbar Init Error:', e);
        }

        // --- Global Variables (Scoped to IIFE) ---
        let currentWeekStart = new Date(2026, 0, 26); // Jan 26, 2026 (Monday)
        const todayDate = new Date(); // Renamed to avoid any potential global conflict
        let eventScroll = null;
        let groupHeaders = [];

        // --- Helper Functions ---

        // Get Monday of current week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        
        // Format date for display
        function formatDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return {
                dayName: days[date.getDay()],
                day: date.getDate(),
                month: months[date.getMonth()],
                year: date.getFullYear(),
                full: `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`
            };
        }
        
        // Get week dates (Monday to Friday)
        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 5; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        // Find first row helper
        function getFirstRowByGroup(id) {
            if (!eventScroll) return null;
            return eventScroll.querySelector(`tr.event-row[data-first-in-group="${id}"]`);
        }

        // --- Core Logic ---

        // Scroll to Date
        // Exposed to window because it might be called from dynamic HTML
        window.scrollToDate = function(id) {
            if (!eventScroll) eventScroll = document.querySelector('.event-scroll');
            if (!eventScroll) return;

            const header = document.getElementById(id);
            const firstRow = getFirstRowByGroup(id);
            const targetEl = firstRow || header;
            
            if (!targetEl) {
                console.warn('Target date element not found:', id);
                return;
            }

            const containerTop = eventScroll.getBoundingClientRect().top;
            const targetTop = targetEl.getBoundingClientRect().top - containerTop + eventScroll.scrollTop;
            
            eventScroll.scrollTo({ top: targetTop, behavior: 'smooth' });
            
            // Allow scroll to finish before updating tab
            setTimeout(updateActiveTab, 150);
        };

        // Update active tab based on scroll position
        function updateActiveTab() {
            if (!eventScroll) return;
            
            // Re-fetch headers to ensure we have the latest
            const currentHeaders = Array.from(document.querySelectorAll('.event-group-header'));
            if (currentHeaders.length === 0) return;
            
            const containerTop = eventScroll.getBoundingClientRect().top;
            let currentHeader = currentHeaders[0];
            const threshold = 50; // increased threshold for better feel

            // Find the header closest to the top
            for (const header of currentHeaders) {
                const headerTop = header.getBoundingClientRect().top - containerTop;
                if (headerTop <= threshold) {
                    currentHeader = header;
                } else {
                    break; // Since they are ordered, we can stop
                }
            }

            if (currentHeader) {
                const dateKey = currentHeader.id; // e.g., "date-19"
                const day = dateKey.replace('date-', '');
                const tabId = `tab-${day}`;
                
                document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
        }

        // Update UI Display
        function updateWeekDisplay() {
            const weekDates = getWeekDates(currentWeekStart);
            const start = formatDate(weekDates[0]);
            const end = formatDate(weekDates[4]);
            
            const rangeDisplay = document.getElementById('week-range-display');
            if (rangeDisplay) {
                rangeDisplay.textContent = `${start.day} ${start.month} - ${end.day} ${end.month} ${start.year}`;
            }
            
            // Update day tabs
            const dayTabs = document.querySelectorAll('.day-tab');
            weekDates.forEach((date, index) => {
                if (dayTabs[index]) {
                    const formatted = formatDate(date);
                    const dayNameEl = dayTabs[index].querySelector('.day-name');
                    const dayDateEl = dayTabs[index].querySelector('.day-date');
                    if (dayNameEl) {
                        dayNameEl.textContent = formatted.dayName;
                    }
                    if (dayDateEl) {
                        dayDateEl.textContent = formatted.day;
                    }
                    
                    // Update ID and Click Listener safely
                    const oldTab = dayTabs[index];
                    const newTab = oldTab.cloneNode(true);
                    newTab.id = `tab-${formatted.day}`;
                    
                    // Use addEventListener instead of onclick
                    newTab.addEventListener('click', function() {
                        window.scrollToDate(`date-${formatted.day}`);
                    });
                    
                    oldTab.parentNode.replaceChild(newTab, oldTab);
                }
            });
            
            // Initialize active tab
            updateActiveTab();
        }

        // ---------- Small inline calendar dropdown for Today button ----------
        function createCalendarHTML(year, month, selectedDate) {
            const monthStart = new Date(year, month, 1);
            const firstWeekday = monthStart.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            let html = '';
            html += `<div class="cal-header"><div class="cal-title" data-year="${year}" data-month="${month}">${monthStart.toLocaleString(undefined,{month:'long'})} ${year}</div><div class="cal-nav"><button data-action="prev">‹</button> <button data-action="next">›</button></div></div>`;
            html += `<div class="cal-grid">`;
            weekdays.forEach(w => html += `<div class="cal-weekday">${w}</div>`);

            // fill leading empty slots
            for (let i = 0; i < firstWeekday; i++) html += `<div class="cal-day empty"></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const selClass = (selectedDate && dateObj.toDateString() === selectedDate.toDateString()) ? 'selected' : '';
                html += `<div class="cal-day ${selClass}" data-day="${d}" title="${dateObj.toDateString()}">${d}</div>`;
            }

            html += `</div>`;
            html += `<div class="cal-shortcuts"><div class="shortcut" data-short="today">Today</div><div class="shortcut" data-short="this-week">This week</div><div class="shortcut" data-short="clear">Close</div></div>`;
            return html;
        }

        function openTodayDropdown(anchorEl) {
            const dropdown = document.getElementById('today-dropdown');
            if (!dropdown) return;

            // position relative to anchor
            const rect = anchorEl.getBoundingClientRect();
            const containerRect = document.querySelector('.content-container').getBoundingClientRect();
            dropdown.style.left = (rect.left - containerRect.left) + 'px';
            dropdown.style.top = (rect.bottom - containerRect.top + 8) + 'px';

            // render current month centered on today
            const now = new Date();
            renderDropdown(now.getFullYear(), now.getMonth(), now);
            dropdown.classList.add('show');
            dropdown.setAttribute('aria-hidden','false');

            // close on outside click
            setTimeout(() => { document.addEventListener('click', outsideClickListener); }, 0);
        }

        function renderDropdown(year, month, selectedDate) {
            const dropdown = document.getElementById('today-dropdown');
            if (!dropdown) return;
            dropdown.innerHTML = createCalendarHTML(year, month, selectedDate);
            attachDropdownHandlers();
        }

        function attachDropdownHandlers() {
            const dropdown = document.getElementById('today-dropdown');
            if (!dropdown) return;
            const titleEl = dropdown.querySelector('.cal-title');
            const year = parseInt(titleEl?.dataset.year, 10);
            const month = parseInt(titleEl?.dataset.month, 10);

            dropdown.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.getAttribute('data-action');
                    const titleElNow = dropdown.querySelector('.cal-title');
                    let yr = parseInt(titleElNow?.dataset.year, 10);
                    let mon = parseInt(titleElNow?.dataset.month, 10);
                    if (Number.isNaN(yr) || Number.isNaN(mon)) { yr = (new Date()).getFullYear(); mon = (new Date()).getMonth(); }
                    if (action === 'prev') { mon -= 1; if (mon < 0) { mon = 11; yr -= 1; } }
                    else if (action === 'next') { mon += 1; if (mon > 11) { mon = 0; yr += 1; } }
                    console.debug('Calendar nav click', action, yr, mon);
                    renderDropdown(yr, mon, new Date());
                });
            });

            bindDropdownDayHandlers();
        }

        function bindDropdownDayHandlers() {
            const dropdown = document.getElementById('today-dropdown');
            if (!dropdown) return;
            dropdown.querySelectorAll('.cal-day:not(.empty)').forEach(dd => {
                dd.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const day = parseInt(dd.getAttribute('data-day'),10);
                    const titleEl = dropdown.querySelector('.cal-title');
                    const year = parseInt(titleEl?.dataset.year, 10);
                    const month = parseInt(titleEl?.dataset.month, 10);
                    if (Number.isNaN(year) || Number.isNaN(month)) return;
                    const selected = new Date(year, month, day);
                    setNewWeek(selected);
                    closeTodayDropdown();
                });
            });
            dropdown.querySelectorAll('.shortcut').forEach(s => {
                s.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const k = s.getAttribute('data-short');
                    if (k === 'today') { setNewWeek(new Date()); closeTodayDropdown(); }
                    else if (k === 'this-week') { setNewWeek(new Date()); closeTodayDropdown(); }
                    else if (k === 'clear') closeTodayDropdown();
                });
            });
        }

        function closeTodayDropdown() {
            const dropdown = document.getElementById('today-dropdown');
            if (!dropdown) return;
            dropdown.classList.remove('show');
            dropdown.setAttribute('aria-hidden','true');
            document.removeEventListener('click', outsideClickListener);
        }

        function outsideClickListener(e) {
            const dropdown = document.getElementById('today-dropdown');
            const btn = document.getElementById('today-btn');
            if (!dropdown) return;
            if (dropdown.contains(e.target) || (btn && btn.contains(e.target))) return;
            closeTodayDropdown();
        }

        // Handle week navigation
        function changeWeek(direction) {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekDisplay();
            renderEvents();
        }

        // Select current week
        function setNewWeek(selectedDate) {
            currentWeekStart = new Date(selectedDate);
            currentWeekStart.setDate(selectedDate.getDate() - 2); // Make selectedDate the middle day (Wednesday)
            updateWeekDisplay();
            renderEvents();
            
            // Scroll to selected date
            const formatted = formatDate(selectedDate);
            setTimeout(() => window.scrollToDate(`date-${formatted.day}`), 100);

            // Update Today button label and native input fallback
            try {
                const todayBtn = document.getElementById('today-btn');
                const datePicker = document.getElementById('date-picker');
                const label = 'Select Day';
                if (todayBtn) todayBtn.textContent = label;
                if (datePicker) datePicker.value = selectedDate.toISOString().slice(0,10);
            } catch (e) {
                console.warn('Could not update Today label/input', e);
            }
        }

        // Event Generation Logic (Mock Data)
        function generateEventsForDate(date, isToday = false) {
            const formatted = formatDate(date);
            const dayOfWeek = date.getDay();
            const events = [];
            
            // Generate mock events based on day of week
            if (dayOfWeek === 1) { // Monday
                events.push(
                    { id: date.getTime() + 101, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Industrial Production m/m', currency: 'JPY', time: '12:30', impact: 'medium', actual: '-1.0%', forecast: '-1.0%', previous: '1.5%', status: 'Expired', actualClass: 'data-neutral' },
                    { id: date.getTime() + 102, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Retail Sales y/y', currency: 'CNY', time: '14:00', impact: 'high', actual: '7.4%', forecast: '8.0%', previous: '10.1%', status: 'Expired', actualClass: 'data-worse' }
                );
            } else if (dayOfWeek === 2) { // Tuesday
                events.push(
                    { id: date.getTime() + 201, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Claimant Count Change', currency: 'GBP', time: '15:00', impact: 'high', actual: '16.0K', forecast: '15.0K', previous: '8.9K', status: 'Expired', actualClass: 'data-worse' },
                    { id: date.getTime() + 202, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'ZEW Economic Sentiment', currency: 'EUR', time: '18:00', impact: 'medium', actual: '15.2', forecast: '12.0', previous: '9.8', status: 'Expired', actualClass: 'data-better' }
                );
            } else if (dayOfWeek === 3) { // Wednesday
                events.push(
                    { id: date.getTime() + 301, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'CPI y/y', currency: 'GBP', time: '15:00', impact: 'high', actual: '4.0%', forecast: '3.8%', previous: '3.9%', status: 'Expired', actualClass: 'data-worse' },
                    { id: date.getTime() + 302, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Core Retail Sales m/m', currency: 'CAD', time: '21:30', impact: 'medium', actual: '-0.5%', forecast: '-0.1%', previous: '0.6%', status: 'Expired', actualClass: 'data-worse' }
                );
            } else if (dayOfWeek === 4) { // Thursday
                const isTodayDate = isToday || (date.getDate() === todayDate.getDate() && date.getMonth() === todayDate.getMonth() && date.getFullYear() === todayDate.getFullYear());
                events.push(
                    { id: date.getTime() + 1, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'CBI Realized Sales', currency: 'GBP', time: '20:00', impact: 'low', actual: '-17', forecast: '-35', previous: '-44', status: 'Expired', actualClass: 'data-better' },
                    { id: date.getTime() + 2, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'ECB Monetary Policy Meeting Accounts', currency: 'EUR', time: '20:30', impact: 'low', actual: '-', forecast: '-', previous: '-', status: 'Expired', isHoliday: false },
                    { id: date.getTime() + 3, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'NHPI m/m', currency: 'CAD', time: '21:30', impact: 'low', actual: '-0.2 %', forecast: '-0.2 %', previous: '0.0 %', status: 'Expired', actualClass: 'data-worse' },
                    { id: date.getTime() + 4, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Final GDP q/q', currency: 'USD', time: '22:30', impact: 'high', actual: isTodayDate ? '4.4 %' : '-', forecast: '4.3 %', previous: '4.3 %', status: isTodayDate ? 'Countdown' : 'Upcoming', timeLeft: isTodayDate ? '00:53:47' : '', actualClass: isTodayDate ? 'data-better' : '' },
                    { id: date.getTime() + 5, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Unemployment Claims', currency: 'USD', time: '22:30', impact: 'high', actual: isTodayDate ? '200 K' : '-', forecast: '209 K', previous: '198 K', status: isTodayDate ? 'Countdown' : 'Upcoming', timeLeft: isTodayDate ? '00:53:47' : '', actualClass: isTodayDate ? 'data-better' : '' },
                    { id: date.getTime() + 6, dateKey: `date-${formatted.day}`, dateDisplay: isTodayDate ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Final GDP Price Index q/q', currency: 'USD', time: '22:30', impact: 'medium', actual: isTodayDate ? '3.8 %' : '-', forecast: '3.8 %', previous: '3.8 %', status: isTodayDate ? 'Countdown' : 'Upcoming', timeLeft: isTodayDate ? '00:53:47' : '', actualClass: isTodayDate ? 'data-neutral' : '' }
                );
            } else if (dayOfWeek === 5) { // Friday
                events.push(
                    { id: date.getTime() + 501, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Flash Manufacturing PMI', currency: 'EUR', time: '16:15', impact: 'medium', actual: '-', forecast: '44.8', previous: '44.4', status: 'Upcoming', actualClass: '' },
                    { id: date.getTime() + 502, dateKey: `date-${formatted.day}`, dateDisplay: isToday ? `Today ${formatted.day} ${formatted.month}` : `${formatted.dayName} ${formatted.day} ${formatted.month}`, description: 'Flash Services PMI', currency: 'GBP', time: '17:30', impact: 'high', actual: '-', forecast: '53.2', previous: '53.4', status: 'Upcoming', actualClass: '' }
                );
            }
            return events;
        }

        function getAllEvents() {
            const allEvents = [];
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            
            getWeekDates(prevWeekStart).forEach(date => allEvents.push(...generateEventsForDate(date, false)));
            getWeekDates(currentWeekStart).forEach(date => {
                const isTodayDate = date.getDate() === todayDate.getDate() && date.getMonth() === todayDate.getMonth() && date.getFullYear() === todayDate.getFullYear();
                allEvents.push(...generateEventsForDate(date, isTodayDate));
            });
            getWeekDates(nextWeekStart).forEach(date => allEvents.push(...generateEventsForDate(date, false)));
            
            return allEvents;
        }

        // Render Events
        function renderEvents() {
            const tbody = document.getElementById('events-body');
            if (!tbody) {
                console.error('Calendar: events-body not found');
                return;
            }
            tbody.innerHTML = '';
            
            const allEvents = getAllEvents();
            
            // Group events
            const groups = {};
            allEvents.forEach(e => {
                if(!groups[e.dateKey]) groups[e.dateKey] = { title: e.dateDisplay, items: [] };
                groups[e.dateKey].items.push(e);
            });

            // Sort logic
            const sortedKeys = Object.keys(groups).sort((a, b) => {
                const dayA = parseInt(a.replace('date-', '')) || 0;
                const dayB = parseInt(b.replace('date-', '')) || 0;
                // Handle month transition rough fix for demo
                if (Math.abs(dayA - dayB) > 20) return dayA > dayB ? -1 : 1; 
                return dayA - dayB;
            });

            sortedKeys.forEach(key => {
                const group = groups[key];
                
                // Sticky Header
                const headerRow = document.createElement('tr');
                headerRow.className = 'event-group-header';
                headerRow.id = key;
                headerRow.innerHTML = `<td colspan="7" class="group-header-cell">${group.title}</td>`;
                tbody.appendChild(headerRow);
                
                // Column Headers
                const colHeaderRow = document.createElement('tr');
                colHeaderRow.className = 'header-row';
                colHeaderRow.innerHTML = `
                    <td style="width: 45%;">Description:</td>
                    <td style="width: 10%;">Instrument:</td>
                    <td style="width: 15%;">Date:</td>
                    <td style="width: 10%; text-align: right;">Actual:</td>
                    <td style="width: 10%; text-align: right;">Forecast:</td>
                    <td style="width: 10%; text-align: right;">Previous:</td>
                    <td style="width: 5%; text-align: right;">Actions:</td>
                `;
                tbody.appendChild(colHeaderRow);

                group.items.forEach((event, index) => {
                    const row = document.createElement('tr');
                    row.className = 'event-row';
                    row.id = `row-${event.id}`;
                    
                    // Click to toggle details
                    row.addEventListener('click', function() {
                        toggleEvent(event.id);
                    });
                    
                    if(event.status === 'Expired') row.classList.add('event-expired');
                    if (index === 0) row.setAttribute('data-first-in-group', key);

                    // ... (Signal Bars, Flag, Time logic same as before, abbreviated for brevity)
                    // Simplified for demo stability
                    
                    let impactClass = event.impact === 'low' ? 'impact-low' : (event.impact === 'medium' ? 'impact-medium' : (event.impact === 'high' ? 'impact-high' : 'impact-holiday'));
                    const impactSignal = `<div class="signal-bars ${impactClass}"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div>`;
                    
                    const actualContent = (event.actual && event.actual !== '-') ? `<span class="${event.actualClass}">${event.actual}</span>` : '-';

                    row.innerHTML = `
                        <td class="event-cell cell-desc"><div style="display:flex; align-items:center;">${impactSignal}<span>${event.description}</span></div></td>
                        <td class="event-cell cell-currency"><span style="font-weight:bold">${event.currency}</span></td>
                        <td class="event-cell cell-time">${event.time}</td>
                        <td class="event-cell cell-data">${actualContent}</td>
                        <td class="event-cell cell-data">${event.forecast}</td>
                        <td class="event-cell cell-data">${event.previous}</td>
                        <td class="event-cell cell-actions">
                            <svg id="icon-${event.id}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Details Row
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'event-details-row';
                    detailsRow.id = `details-${event.id}`;
                    detailsRow.innerHTML = `<td colspan="7"><div class="event-details-container">Details for ${event.description}...</div></td>`;
                    tbody.appendChild(detailsRow);
                });
            });
            
            // Re-bind scroll listener
            bindScrollListener();
        }

        function toggleEvent(id) {
            const details = document.getElementById(`details-${id}`);
            const row = document.getElementById(`row-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (!details) return;
            
            if (details.style.display === 'table-row') {
                details.style.display = 'none';
                if(row) row.classList.remove('expanded');
                if(icon) icon.style.transform = 'rotate(0deg)';
            } else {
                details.style.display = 'table-row';
                if(row) row.classList.add('expanded');
                if(icon) icon.style.transform = 'rotate(180deg)';
            }
        }

        // Scroll listener logic
        function bindScrollListener() {
            eventScroll = document.querySelector('.event-scroll');
            if (eventScroll) {
                // Ensure we don't bind duplicate listeners if function called multiple times
                // Cloning node is a dirty hack to strip listeners, better to use named reference if possible
                // But here we just redefine the handler logic
                eventScroll.onscroll = function() {
                    updateActiveTab();
                    handleWeekChangeOnScroll();
                };
                updateActiveTab();
            }
        }

        let scrollUpdateTimeout = null;
        function handleWeekChangeOnScroll() {
            if (scrollUpdateTimeout) clearTimeout(scrollUpdateTimeout);
            scrollUpdateTimeout = setTimeout(() => {
                // ... logic to detect week change (abbreviated for stability) ...
                // For demo, keep it simple
            }, 150);
        }

        // Initialization
        function initializeCalendar() {
            console.log('Calendar: Initializing...');
            
            // Bind Controls
            const todayBtn = document.getElementById('today-btn');
            const datePicker = document.getElementById('date-picker');
            if (todayBtn) {
                todayBtn.addEventListener('click', (e) => {
                    const dd = document.getElementById('today-dropdown');
                    if (dd && dd.classList.contains('show')) { closeTodayDropdown(); }
                    else openTodayDropdown(todayBtn);
                    e.stopPropagation();
                });
                // Set initial label
                todayBtn.textContent = 'Select Day';
            }
            // keep native input as fallback for non-js or direct selection
            if (datePicker) datePicker.addEventListener('change', (e) => {
                const selectedDate = new Date(e.target.value);
                setNewWeek(selectedDate);
            });
            
            const prevBtn = document.getElementById('week-prev-btn');
            if (prevBtn) prevBtn.addEventListener('click', function() { changeWeek(-1); });
            
            const nextBtn = document.getElementById('week-next-btn');
            if (nextBtn) nextBtn.addEventListener('click', function() { changeWeek(1); });

            // Initial Render
            currentWeekStart = getMonday(todayDate);
            updateWeekDisplay();
            renderEvents();
            
            // Bind global scroll capture for mouse wheel
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.addEventListener('wheel', (e) => {
                    if (eventScroll && !eventScroll.contains(e.target) && e.target !== eventScroll) {
                        eventScroll.scrollTop += e.deltaY;
                    }
                }, { passive: true });
            }

            console.log('Calendar: Initialization Complete');
        }

        // Start initialization
        setTimeout(initializeCalendar, 100);

    })();
    </script>
</body>
</html>